<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <link rel="stylesheet" type="text/css" href="css/main.css" />
  <script src="js/bugzilla.js"></script>
</head>
<body>

<div class="version-fixed-bugs">
  <div id="main" class="chart-data">
    <div class="horizontal-scroll-bar"></div>
  </div>
  <!-- <div>
    <i class="arrow right"></i>
  </div> -->
</div>
</body>
<script>

function GetCanvasForVersion(version) {
  let canvas = document.createElement('canvas');
  canvas.id = `chart_${version}`;
  canvas.style = "width:100%;height:75%;";
  return canvas;
}

async function GetPieChartForFixedBugsFromVersion(version) {
  const root = createFixedBugListVisualRoot();

  let titleDiv = document.createElement("div");
  let title = document.createElement('h2');
  title.innerHTML = `Firefox ${version} Fixed Bugs Overview`;
  titleDiv.className = "title";
  titleDiv.appendChild(title);
  root.appendChild(titleDiv);

  let desDiv = document.createElement("div");
  let buglistLink = document.createElement("a");
  buglistLink.innerHTML = "buglist";
  buglistLink.href = GetBugListLinkForVersion(version);
  desDiv.appendChild(buglistLink);
  desDiv.className = "description"
  root.appendChild(desDiv);

  let canvas = GetCanvasForVersion(version);
  root.appendChild(canvas);

  await createPieChart(canvas, version);
}

function createFixedBugListVisualRoot() {
  let root = document.createElement("div");
  root.className = "fixed-bug-list";
  document.querySelector(".chart-data > .horizontal-scroll-bar").appendChild(root);
  return root;
}

async function createPieChart(canvas, version) {
const BAR_COLOERS = [
    "#b91d47",
    "#00aba9",
    "#2b5797",
    "#e8c3b9",
    "#1e7145",
    "#7b3627",
    "#27767b",
    "#337b27",
    "#d347df",
    "#4756df",
  ];

  let buglist = await GenerateFixedBugListForVersion(version);
  let data = GetCategoriesDistributionFromBugList(buglist);

  // convert map to arrays
  let categories = Array.from(data.keys());
  let bugAmounts = Array.from(data.values());

  new Chart(canvas, {
    type: "pie",
    data: {
      labels: categories,
      datasets: [{
        backgroundColor: BAR_COLOERS,
        data: bugAmounts
      }]
    },
    options: {
      legend: {
        // https://www.chartjs.org/docs/latest/configuration/legend.html#legend-label-configuration
        labels: {
          boxWidth:20,
          // generateLabels: function(chart) {
          //   return "";
          // }
        }
      }
    }
  });
}

(async _ => {
  const latestVersion = 110;
  const displayVersionAmount = 5;
  for (let ver = latestVersion; ver > latestVersion - displayVersionAmount; ver--) {
    GetPieChartForFixedBugsFromVersion(ver);
  }
})();

</script>
</html>